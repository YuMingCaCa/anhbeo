<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bếp - Quán Anh Béo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .order-card-new { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .toast-enter { transform: translateX(100%); opacity: 0; transition: all 0.3s ease-out; }
        .toast-enter-active { transform: translateX(0); opacity: 1; }
    </style>
</head>
<body class="bg-gray-200">

    <!-- Sound Activation Modal -->
    <div id="sound-modal" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="text-white text-6xl mb-4">
            <i class="fas fa-volume-up"></i>
        </div>
        <h2 class="text-white text-2xl font-bold mb-4">Kích hoạt âm thanh thông báo</h2>
        <p class="text-gray-300 text-center mb-6 max-w-sm">Do quy định của trình duyệt, bạn cần nhấn nút này mỗi khi tải trang để nhận thông báo bằng âm thanh và giọng nói.</p>
        <button id="enable-sound-btn" class="bg-blue-500 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-blue-600 transition-colors">
            Bắt đầu làm việc
        </button>
    </div>

    <!-- Main Content (initially hidden) -->
    <div id="main-container" class="hidden">
        <div class="container mx-auto p-4">
            <header class="text-center mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Màn Hình Bếp</h1>
                <p class="text-gray-600 mt-2">Các đơn hàng mới sẽ hiện ở đây</p>
            </header>
            <main id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <p id="loading-message" class="text-center text-gray-500 col-span-full">Đang chờ đơn hàng mới...</p>
            </main>
        </div>
    </div>
    
    <audio id="notification-sound" src="Alarm.mp3" preload="auto"></audio>

    <div id="toast-notification" class="hidden fixed top-5 right-5 bg-blue-500 text-white py-3 px-5 rounded-lg shadow-lg z-50 flex items-center gap-3 toast-enter">
        <i class="fas fa-receipt"></i>
        <span id="toast-message"></span>
    </div>

    <script type="module">
        // filepath: d:\1 HE THONG WEB\goiMonQR\kitchen.html
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDosCykP-rrTVAlwfAOXDGgGioxtt-VrOs",
            authDomain: "quanlykinhdoanh-cb2b1.firebaseapp.com",
            projectId: "quanlykinhdoanh-cb2b1",
            storageBucket: "quanlykinhdoanh-cb2b1.firebasestorage.app",
            messagingSenderId: "478736931655",
            appId: "1:478736931655:web:b216ac919d9aeca334ca62"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const soundModal = document.getElementById('sound-modal');
        const enableSoundBtn = document.getElementById('enable-sound-btn');
        const mainContainer = document.getElementById('main-container');
        const notificationSound = document.getElementById('notification-sound');
        const ordersGrid = document.getElementById('orders-grid');
        const loadingMessage = document.getElementById('loading-message');
        const toastNotification = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');

        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

        const showToast = (message) => {
            toastMessage.textContent = message;
            toastNotification.classList.remove('hidden', 'toast-enter');
            setTimeout(() => toastNotification.classList.add('toast-enter-active'), 10);
            setTimeout(() => {
                toastNotification.classList.remove('toast-enter-active');
                setTimeout(() => toastNotification.classList.add('hidden'), 300);
            }, 5000);
        };

        // --- Text-to-Speech Functionality ---
        let vietnameseVoice = null;
        const speechQueue = [];
        let isSpeechInitialized = false;
        let isCurrentlySpeaking = false;

        function findAndSetVoice() {
            if (!('speechSynthesis' in window)) return false;
            const voices = window.speechSynthesis.getVoices();
            vietnameseVoice = voices.find(v => v.lang === 'vi-VN') || voices.find(v => v.lang.startsWith('vi'));
            if (vietnameseVoice) {
                isSpeechInitialized = true;
                processSpeechQueue();
                return true;
            }
            return false;
        }

        function initializeSpeech() {
            if (!('speechSynthesis' in window)) {
                console.error("Trình duyệt này không hỗ trợ giọng nói.");
                return;
            }
            // Luôn lắng nghe sự kiện voiceschanged
            window.speechSynthesis.onvoiceschanged = () => {
                findAndSetVoice();
            };
            // Thử lấy voice ngay lập tức
            findAndSetVoice();
        }

        function processSpeechQueue() {
            if (!isSpeechInitialized || isCurrentlySpeaking || speechQueue.length === 0) return;
            isCurrentlySpeaking = true;
            const textToSpeak = speechQueue.shift();
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.voice = vietnameseVoice;
            utterance.lang = 'vi-VN';
            utterance.rate = 0.95;
            utterance.onend = () => {
                isCurrentlySpeaking = false;
                setTimeout(processSpeechQueue, 100);
            };
            utterance.onerror = (event) => {
                console.error("Lỗi khi phát giọng nói:", event.error);
                isCurrentlySpeaking = false;
                processSpeechQueue();
            };
            window.speechSynthesis.speak(utterance);
        }

        const speak = (text) => {
            speechQueue.push(text);
            processSpeechQueue();
        };
        // --- END Text-to-Speech ---

        const startApp = () => {
            soundModal.classList.add('hidden');
            mainContainer.classList.remove('hidden');

            // Đảm bảo không bị lặp sự kiện khi có nhiều đơn mới liên tiếp
            let soundBusy = false;

            const q = query(collection(db, "quan-anh-beo-orders"), where("status", "==", "new"));
            onSnapshot(q, (snapshot) => {
                loadingMessage.style.display = snapshot.empty ? 'block' : 'none';
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const newOrder = { id: change.doc.id, ...change.doc.data() };
                        renderOrder(newOrder);

                        // Phát âm thanh cảnh báo, sau đó mới đọc giọng nói
                        const itemsText = newOrder.items.map(item => `${item.quantity} ${item.name}`).join(', ');
                        const announcementText = `Có đơn mới từ Bàn ${newOrder.table}. Gồm có: ${itemsText}`;

                        // Nếu đang phát âm thanh cảnh báo thì bỏ qua, tránh lặp
                        if (!soundBusy) {
                            soundBusy = true;
                            notificationSound.currentTime = 0;
                            notificationSound.play().catch(e => console.log("Lỗi phát âm thanh:", e));
                            notificationSound.onended = () => {
                                speak(announcementText);
                                soundBusy = false;
                            };
                        } else {
                            // Nếu đang bận, vẫn xếp thông báo vào hàng đợi giọng nói
                            setTimeout(() => speak(announcementText), 1000);
                        }

                        showToast(`Có đơn hàng mới từ Bàn ${newOrder.table}!`);
                    }
                    if (change.type === "removed") {
                        const cardToRemove = document.getElementById(`order-${change.doc.id}`);
                        if (cardToRemove) cardToRemove.remove();
                    }
                });
            });
        };

        enableSoundBtn.addEventListener('click', () => {
            initializeSpeech();
            notificationSound.play().then(() => {
                notificationSound.pause();
                notificationSound.currentTime = 0;
            }).catch(error => {
                console.warn("Không thể phát âm thanh để kích hoạt, nhưng vẫn tiếp tục vì người dùng đã tương tác.", error);
            });
            startApp();
        });

        const renderOrder = (order) => {
            const orderCard = document.createElement('div');
            orderCard.id = `order-${order.id}`;
            orderCard.className = 'bg-white rounded-lg shadow-lg p-4 flex flex-col order-card-new';
            const itemsHtml = order.items.map(item => `<li class="flex justify-between"><span>${item.name}</span><span class="font-semibold">x${item.quantity}</span></li>`).join('');
            orderCard.innerHTML = `
                <div class="border-b pb-2 mb-2">
                    <h3 class="text-2xl font-bold">Bàn ${order.table}</h3>
                    <p class="text-sm text-gray-500">Lúc: ${new Date(order.createdAt.seconds * 1000).toLocaleTimeString('vi-VN')}</p>
                </div>
                <ul class="space-y-1 flex-grow mb-4">${itemsHtml}</ul>
                <div class="border-t pt-2 mt-auto">
                     <p class="text-lg font-bold text-right">Tổng: ${formatCurrency(order.total)}</p>
                    <button data-id="${order.id}" class="complete-btn mt-4 w-full bg-green-500 text-white py-2 rounded-lg font-bold hover:bg-green-600 transition-colors">Hoàn Thành</button>
                </div>
            `;
            ordersGrid.prepend(orderCard);
        };

        ordersGrid.addEventListener('click', async (e) => {
            const target = e.target.closest('.complete-btn');
            if (!target) return;
            const id = target.dataset.id;
            target.disabled = true;
            target.textContent = 'Đang xử lý...';
            await updateDoc(doc(db, "quan-anh-beo-orders", id), { status: "completed" });
        });
    </script>
</body>
</html>
