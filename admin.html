<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Thực Đơn - Quán Anh Béo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Sound Activation Modal -->
    <div id="sound-modal" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="text-white text-6xl mb-4"><i class="fas fa-volume-up"></i></div>
        <h2 class="text-white text-2xl font-bold mb-4">Kích hoạt âm thanh thông báo</h2>
        <p class="text-gray-300 text-center mb-6 max-w-sm">Do quy định của trình duyệt, bạn cần nhấn nút này mỗi khi tải trang để nhận thông báo bằng âm thanh.</p>
        <button id="enable-sound-btn" class="bg-blue-500 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-blue-600 transition-colors">Bắt đầu làm việc</button>
    </div>

    <!-- Main Content (initially hidden) -->
    <div id="main-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="text-center mb-8 relative">
                <h1 class="text-4xl font-bold text-gray-800">Quản Lý Thực Đơn</h1>
                <p class="text-gray-600 mt-2">Dành cho chủ quán "Anh Béo"</p>
                <!-- Nút tạo mã QR -->
                <a href="generate_qr.html" target="_blank" class="absolute top-0 right-0 bg-teal-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-teal-600 transition-colors flex items-center gap-2 shadow-md">
                    <i class="fas fa-qrcode"></i>
                    <span>Tạo mã QR</span>
                </a>
            </header>

            <!-- Bố cục 2 cột cho Form và Quản lý Phân loại -->
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <!-- Form để thêm/sửa món ăn -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4" id="form-title">Thêm Món Ăn Mới</h2>
                    <form id="product-form" class="space-y-4">
                        <input type="hidden" id="product-id">
                        <div>
                            <label for="product-name" class="block text-sm font-medium text-gray-700">Tên món ăn</label>
                            <input type="text" id="product-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="product-price" class="block text-sm font-medium text-gray-700">Giá (VNĐ)</label>
                            <input type="number" id="product-price" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="product-category-select" class="block text-sm font-medium text-gray-700">Phân loại</label>
                            <select id="product-category-select" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Chọn loại món ăn --</option>
                            </select>
                        </div>
                        <div class="flex gap-4 pt-2">
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-save mr-2"></i><span id="save-btn-text">Lưu Món</span>
                            </button>
                            <button type="button" id="cancel-edit-btn" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 hidden">Hủy</button>
                        </div>
                    </form>
                </div>
                <!-- Quản lý Phân Loại -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Quản Lý Phân Loại</h2>
                    <form id="add-category-form" class="flex gap-2 mb-4">
                        <input type="text" id="new-category-name" placeholder="Nhập tên loại mới..." required class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <button type="submit" class="flex-shrink-0 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600"><i class="fas fa-plus"></i> Thêm</button>
                    </form>
                    <div id="category-management-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <p class="text-center text-gray-500">Đang tải danh sách phân loại...</p>
                    </div>
                </div>
            </div>
            
            <!-- Danh sách món ăn -->
            <div>
                <h2 class="text-2xl font-bold mb-4">Danh Sách Món Ăn Hiện Tại</h2>
                <div id="product-list" class="space-y-6">
                    <p id="loading-products" class="text-center text-gray-500">Đang tải danh sách món ăn...</p>
                </div>
            </div>
        </div>
    </div>

    <audio id="notification-sound" src="Alarm.mp3" preload="auto"></audio>
    <div id="toast-notification" class="hidden fixed top-5 right-5 bg-blue-500 text-white py-3 px-5 rounded-lg shadow-lg z-50 flex items-center gap-3">
        <i class="fas fa-receipt"></i>
        <span id="toast-message"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // ... (Toàn bộ mã JavaScript giữ nguyên như cũ, không thay đổi)
        const firebaseConfig = {
            apiKey: "AIzaSyDosCykP-rrTVAlwfAOXDGgGioxtt-VrOs",
            authDomain: "quanlykinhdoanh-cb2b1.firebaseapp.com",
            projectId: "quanlykinhdoanh-cb2b1",
            storageBucket: "quanlykinhdoanh-cb2b1.firebasestorage.app",
            messagingSenderId: "478736931655",
            appId: "1:478736931655:web:b216ac919d9aeca334ca62"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const menuCollection = collection(db, "quan-anh-beo-menu");
        const categoriesCollection = collection(db, "quan-anh-beo-categories");
        const ordersCollection = collection(db, "quan-anh-beo-orders");

        // --- DOM Elements ---
        const soundModal = document.getElementById('sound-modal');
        const enableSoundBtn = document.getElementById('enable-sound-btn');
        const mainContainer = document.getElementById('main-container');
        const notificationSound = document.getElementById('notification-sound');
        const toastNotification = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        const addCategoryForm = document.getElementById('add-category-form');
        const categoryManagementList = document.getElementById('category-management-list');
        const productForm = document.getElementById('product-form');
        const productListDiv = document.getElementById('product-list');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        let allProducts = [];

        // --- Utility Functions ---
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const normalizeCategory = (str) => {
            if (!str) return '';
            const trimmedStr = str.trim();
            if (trimmedStr.length === 0) return '';
            return trimmedStr.charAt(0).toUpperCase() + trimmedStr.slice(1);
        };
        const showToast = (message) => {
            toastMessage.textContent = message;
            toastNotification.classList.remove('hidden');
            setTimeout(() => {
                toastNotification.classList.add('hidden');
            }, 5000);
        };

        // --- Render Functions ---
        const renderCategories = (categories) => {
            const productCategorySelect = document.getElementById('product-category-select');
            categoryManagementList.innerHTML = '';
            if (categories.length === 0) {
                categoryManagementList.innerHTML = '<p class="text-center text-gray-500">Chưa có phân loại nào.</p>';
            } else {
                categories.sort((a, b) => a.name.localeCompare(b.name)).forEach(cat => {
                    const catEl = document.createElement('div');
                    catEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md';
                    catEl.innerHTML = `<span>${cat.name}</span><button data-id="${cat.id}" data-name="${cat.name}" class="delete-category-btn text-red-500 hover:text-red-700 w-8 h-8 rounded-full hover:bg-red-50 flex items-center justify-center transition-colors"><i class="fas fa-trash"></i></button>`;
                    categoryManagementList.appendChild(catEl);
                });
            }
            productCategorySelect.innerHTML = '<option value="">-- Chọn loại món ăn --</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                productCategorySelect.appendChild(option);
            });
        };
        const renderProducts = (products) => {
            const loadingMessage = document.getElementById('loading-products');
            productListDiv.innerHTML = '';
            if (products.length === 0) {
                loadingMessage.textContent = 'Chưa có món ăn nào. Vui lòng thêm ở trên.';
                loadingMessage.style.display = 'block';
                return;
            }
            loadingMessage.style.display = 'none';
            const groupedProducts = products.reduce((acc, product) => {
                const category = product.category || 'Chưa phân loại';
                if (!acc[category]) acc[category] = [];
                acc[category].push(product);
                return acc;
            }, {});
            Object.keys(groupedProducts).sort().forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'mb-6 bg-white p-5 rounded-lg shadow-md';
                categorySection.innerHTML = `<h3 class="text-xl font-bold text-gray-800 mb-3 pb-2 border-b">${category}</h3>`;
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-3';
                groupedProducts[category].sort((a, b) => a.name.localeCompare(b.name)).forEach(product => {
                    const productEl = document.createElement('div');
                    productEl.className = 'flex justify-between items-center p-3 rounded-md hover:bg-gray-50';
                    productEl.innerHTML = `<div><p class="font-bold text-lg">${product.name}</p><p class="text-gray-600 text-sm">${formatCurrency(product.price)}</p></div><div class="flex items-center gap-2"><button data-id="${product.id}" class="edit-btn text-blue-500 hover:text-blue-700 w-10 h-10 rounded-full hover:bg-blue-50 flex items-center justify-center"><i class="fas fa-edit"></i></button><button data-id="${product.id}" class="delete-btn text-red-500 hover:text-red-700 w-10 h-10 rounded-full hover:bg-red-50 flex items-center justify-center"><i class="fas fa-trash"></i></button></div>`;
                    itemsContainer.appendChild(productEl);
                });
                categorySection.appendChild(itemsContainer);
                productListDiv.appendChild(categorySection);
            });
        };

        // --- Main Application Logic ---
        const startApp = () => {
            // Hide modal, show main content
            soundModal.classList.add('hidden');
            mainContainer.classList.remove('hidden');

            // Start all Firebase listeners
            onSnapshot(query(categoriesCollection), (snapshot) => renderCategories(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))), console.error);
            onSnapshot(query(menuCollection), (snapshot) => {
                allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts(allProducts);
            }, console.error);
            onSnapshot(query(ordersCollection, where("status", "==", "new")), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const newOrder = change.doc.data();
                        notificationSound.play().catch(e => console.log("Lỗi phát âm thanh:", e));
                        showToast(`Có đơn hàng mới từ Bàn ${newOrder.table}!`);
                    }
                });
            });
        };
        
        enableSoundBtn.addEventListener('click', () => {
             // Play a silent sound to unlock the audio context
            notificationSound.play().then(() => {
                notificationSound.pause();
                notificationSound.currentTime = 0;
            }).catch(error => {
                console.warn("Không thể phát âm thanh để kích hoạt, nhưng vẫn tiếp tục vì người dùng đã tương tác.", error);
            });
            startApp();
        });

        // --- Other Event Handlers ---
        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCategoryNameInput = document.getElementById('new-category-name');
            const categoryName = normalizeCategory(newCategoryNameInput.value);
            if (!categoryName) return;
            const q = query(categoriesCollection, where("name", "==", categoryName));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                alert('Phân loại này đã tồn tại!');
                return;
            }
            try {
                await addDoc(categoriesCollection, { name: categoryName });
                addCategoryForm.reset();
            } catch (error) {
                console.error("Lỗi khi thêm phân loại: ", error);
                alert("Không thể thêm phân loại mới.");
            }
        });

        categoryManagementList.addEventListener('click', async (e) => {
            const target = e.target.closest('.delete-category-btn');
            if (!target) return;
            const categoryId = target.dataset.id;
            const categoryName = target.dataset.name;
            const isCategoryInUse = allProducts.some(p => p.category === categoryName);
            if (isCategoryInUse) {
                alert(`Không thể xóa! Phân loại "${categoryName}" đang được sử dụng cho một hoặc nhiều món ăn.`);
                return;
            }
            if (confirm(`Bạn có chắc muốn xóa phân loại "${categoryName}"?`)) {
                try {
                    await deleteDoc(doc(db, "quan-anh-beo-categories", categoryId));
                } catch (error) {
                    console.error("Lỗi khi xóa phân loại: ", error);
                    alert("Không thể xóa phân loại.");
                }
            }
        });

        const resetProductForm = () => {
            const productIdInput = document.getElementById('product-id');
            const formTitle = document.getElementById('form-title');
            const saveBtnText = document.getElementById('save-btn-text');
            const productNameInput = document.getElementById('product-name');
            productForm.reset();
            productIdInput.value = '';
            formTitle.textContent = 'Thêm Món Ăn Mới';
            saveBtnText.textContent = 'Lưu Món';
            cancelEditBtn.classList.add('hidden');
            productNameInput.focus();
        };

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productIdInput = document.getElementById('product-id');
            const productNameInput = document.getElementById('product-name');
            const productPriceInput = document.getElementById('product-price');
            const productCategorySelect = document.getElementById('product-category-select');
            const id = productIdInput.value;
            const productData = {
                name: productNameInput.value,
                price: Number(productPriceInput.value),
                category: productCategorySelect.value
            };
            if (!productData.category) {
                alert("Vui lòng chọn phân loại cho món ăn!");
                return;
            }
            try {
                if (id) {
                    await updateDoc(doc(db, "quan-anh-beo-menu", id), productData);
                } else {
                    await addDoc(menuCollection, productData);
                }
                resetProductForm();
            } catch (error) {
                console.error("Lỗi khi lưu món ăn: ", error);
                alert("Đã có lỗi xảy ra, không thể lưu món ăn!");
            }
        });

        productListDiv.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            const productDocRef = doc(db, "quan-anh-beo-menu", id);
            if (target.classList.contains('delete-btn')) {
                if (confirm('Bạn có chắc muốn xóa món ăn này?')) {
                    await deleteDoc(productDocRef).catch(console.error);
                }
            } else if (target.classList.contains('edit-btn')) {
                const docSnap = await getDocs(query(menuCollection, where('__name__', '==', id)));
                if (!docSnap.empty) {
                    const product = docSnap.docs[0].data();
                    const productIdInput = document.getElementById('product-id');
                    const productNameInput = document.getElementById('product-name');
                    const productPriceInput = document.getElementById('product-price');
                    const productCategorySelect = document.getElementById('product-category-select');
                    const formTitle = document.getElementById('form-title');
                    const saveBtnText = document.getElementById('save-btn-text');
                    productIdInput.value = id;
                    productNameInput.value = product.name;
                    productPriceInput.value = product.price;
                    productCategorySelect.value = product.category;
                    formTitle.textContent = 'Chỉnh Sửa Món Ăn';
                    saveBtnText.textContent = 'Cập Nhật';
                    cancelEditBtn.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    productNameInput.focus();
                }
            }
        });

        cancelEditBtn.addEventListener('click', resetProductForm);
    </script>
</body>
</html>
